<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="my-admin">
  <template>
    <style include="shared-styles">
    .interrupt{
        flex-grow: 0.5;
    }
    .flexBox {
        display : flex;
        align-items: center;
        padding: 10px 15px;
        margin-top: 20px;
        font-size: 18px;
        flex-flow: row wrap;
        align-content : space-between;
    }
    .flexBox > * {
    margin: 20px 20px;
    }
    
      span,
      input {
        @apply(--paper-font-body2);
      }
      .icon1{
          opacity: 0.54;
          width : 50px;
          height : 50px;
      }
    .icon2{
        opacity: 0.54;
    }
    paper-material.custom {
      width: 100px;
      text-align: center;
        margin  : 10px;
    --paper-button-ink-color: var(--paper-pink-a200);
    /* These could also be individually defined for each of the
      specific css classes, but we'll just do it once as an example */
    --paper-button-flat-keyboard-focus: {
      background-color: var(--paper-pink-a200);
      color: white !important;
    };
    --paper-button-raised-keyboard-focus: {
      background-color: var(--paper-pink-a200) !important;
      color: white !important;
    };
  }
  paper-material.green:hover {
    background-color: var(--paper-green-200);
  }
  paper-material.red:hover {
    background-color: var(--paper-red-200);
  }
  paper-material.green {
    background-color: var(--paper-green-500);
    color: white;
  }
  paper-material.red{
    background-color: var(--paper-red-500);
    color: white;
  }
  .farm{
    display: block;
  }
  .farm iron-icon{
    display: inline-block;
  }
  .farm a {
  color:inherit;
  text-decoration: none;
 }

    </style>
      <mqtt-connection auto
                       id="connection" url="ws://test.mosquitto.org:8080"
                       on-mqtt-message="hundle_message">
          <template is="dom-repeat" items="{{farms}}" as="item">
              <mqtt-subscription topic="/m3ftah/{{item.name}}/connected"></mqtt-subscription>
          </template>
    </mqtt-connection>
    <div class="flexBox">
      <paper-material elevation="1">
      <h4>List of farms</h4>
         <div class="flexBox">
          <template id="repeatT" is="dom-repeat" items="{{farms}}" as="item">
          <paper-material elevation="2" class$="{{getClass(item.connected)}}">
          <div class="farm">
              <a href$="{{baseUrl}}farm/{{item.name}}" on-tap="enter" data-args="{{item.index}}">{{item.name}}
              </a>
          </div>
          <div class="farm">
              <iron-icon id="connected" icon="icons:visibility" hidden$="{{!item.connected}}"></iron-icon>
              <iron-icon id="disconnected" icon="icons:visibility-off" hidden$="{{item.connected}}"></iron-icon>
              <iron-icon id="id_camera" icon="icons:camera-enhance" hidden$="{{!item.camera}}"></iron-icon>
              <paper-tooltip for="id_camera" offset="0">Camera!</paper-tooltip>
              <paper-tooltip for="connected" offset="0">Connected!</paper-tooltip>
              <paper-tooltip for="disconnected" offset="0">Not connected!</paper-tooltip>
          </div>
          </paper-material>
          </template>
         </div>
      </paper-material>     

      <paper-material elevation="1">
        <div>
          <my-pie></my-pie>
        </div>
      </paper-material>

      <paper-material elevation="1">
        <div>
          <my-reg></my-reg>
        </div>
      </paper-material>

      <paper-material elevation="1">
        <div>
          <my-table></my-table>
        </div>
      </paper-material>

      <paper-material elevation="1">
        <div>
          <my-chart></my-chart>
        </div>
      </paper-material>

      <paper-material elevation="1">
        <div>
          <my-chart-irrigation></my-chart-irrigation>
        </div>
      </paper-material>

      

      </div>

      <paper-toast id="toast0" text=""></paper-toast>
    
  </template>

  <script>
    (function() {
        'use strict';
        //var farms = ['Ali', 'Brahim', 'Hamza', 'Yacine'];
        polyapp.farms = [];
        polyapp.index = 0;
        function Farm(index, name, connected, client,camera) {
            this.index = index;
            this.name = name;
            this.connected = connected;
            this.client = client;
            this.camera = camera;
        }
        polyapp.farms.push(new Farm(0, 'Brahim', false, 'Raspberry pi',true));
        polyapp.farms.push(new Farm(1, 'Ali', false, 'Arduino',false));
        polyapp.farms.push(new Farm(2, 'Yacine', false, 'Arduino',false));
        polyapp.farms.push(new Farm(3, 'Hamza', false, 'Raspberry pi',false));
        //console.log(polyapp.farms);
      Polymer({
        is: 'my-admin',

        properties: {
            farms:{
                type:Object,
                value: polyapp.farms
            },
          pin :{
            type : String,
            value : 1
          },
          marche:{
            type: String,
            value: 2,
            notify : true
          },
          arret:{
            type: String,
            value: 1,
            notify : true
          },
          url:{
            type : String
          }
        },
        getClass: function (item) {
            return (item ? 'custom green' : 'custom red');
        },
        enter: function (e) {
          polyapp.index = e.target.dataArgs;
          polyapp.farm = polyapp.farms[polyapp.index];
        },
        toggle : function() {
        },
        postComplete : function(){
              //console.log(this.postResponse);
        },
        hundle_message: function (e, mqtt) {
            var str = String.fromCharCode.apply(null, mqtt.message);
            var myobj = JSON.parse(str);
            var farms = [];
            var j=0;
            for (var i in this.farms) {
                if (mqtt.topic.indexOf(this.farms[i].name) > -1) {
                    j = i;
                    farms.push(new Farm(this.farms[i].index, this.farms[i].name, myobj, this.farms[i].client,this.farms[i].camera));
                } else farms.push(this.farms[i]);
            }
            var state = this.farms[j].connected;
            this.farms = farms;
            polyapp.farms = farms;
            var toast = this.$.toast0;
            if (myobj != state){
              toast0.text = 'La ferme de ' + this.farms[j].name + (myobj ? ' est connecté' :' est déconnecté');
              toast0.open();
            }
            
        },
        ready: function() {
            var element = this;
        },
        handleResponse : function( doc, res){
            var temps = [],humids = [], sample = polyapp.ajaxResponse;
            //console.log(sample);
            for(var x in sample){
                var tab1 = [],tab2=[];
                tab1.push(new Date(sample[x].date));
                tab2.push(new Date(sample[x].date));
                tab1.push(sample[x].temp);
                tab2.push(sample[x].humid);
                temps.push(tab1);
                humids.push(tab2);
            }    
            polyapp.temps = temps;
            polyapp.humids = humids;
        }
      });
    })();
  </script>
</dom-module>
