<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="my-farm">
  <template>
    <style include="shared-styles">
    .interrupt{
        flex-grow: 0.5;
    }
    .collapse-content {
      padding: 15px;
      border: 1px solid #dedede;
      border-radius: 5px;
    }
    .flexBox {
        display : flex;
        align-items: center;
        padding: 10px 15px;
        margin-top: 20px;
        font-size: 18px;
        flex-flow: row wrap;
        align-content : space-between;
    }
    .flexBox > * {
    margin: 20px 20px;
    }
    paper-material{
        padding : 0px 20px;
    }
    paper-button.custom {
        margin  : 10px;
    --paper-button-ink-color: var(--paper-pink-a200);
    /* These could also be individually defined for each of the
      specific css classes, but we'll just do it once as an example */
    --paper-button-flat-keyboard-focus: {
      background-color: var(--paper-pink-a200);
      color: white !important;
    };
    --paper-button-raised-keyboard-focus: {
      background-color: var(--paper-pink-a200) !important;
      color: white !important;
    };
  }
  paper-button.green:hover {
    background-color: var(--paper-green-200);
  }
  paper-button.red:hover {
    background-color: var(--paper-red-200);
  }
  paper-button.green {
    background-color: var(--paper-green-500);
    color: white;
  }
  paper-button.red{
    background-color: var(--paper-red-500);
    color: white;
  }
  .head *{
    display: inline-block;
  }
  #stream {
              width: 320px;
              height: 240px;
              background: #ddd;
              margin-top : 30px;
              margin-bottom : 30px;
            }
  #splineChart {
    margin-top : 30px;
  }

    </style>
      
      <h2 class="page-title">La ferme de {{farm.name}}</h2>
      <div class="app">
            <h1>Bluetooth Serial</h1>
            <span id="fooBar"></span>
            <div id="mainPage">
                <ul id="deviceList">
                </ul>
          <paper-button raised class="custom green" on-click="connect">Connect</paper-button>
            </div>
            <div id="detailPage">
                <span>{{message}}</span>
                <<paper-card heading="Card title" image="" elevation="1" animated-shadow="false">
                  <div class="card-content"></div>
                  <div class="card-actions">
                    <<iron-icon icon="icons:account-circle"></iron-icon>
                  </div>
                </paper-card>
                <div>
                    <input type="text" id="messageInput" value="Hello"/>
                    <paper-button raised class="custom green" on-click="send">Send</paper-button>
                <paper-toggle-button  id="interrupt" style="float:left;">int√©rrupteur</paper-toggle-button>
                </div>
                <button id="disconnectButton">Disconnect</button>
            </div>
            <div id="statusDiv"></div>
        </div>
    <div>
        <paper-material elevation="1">
        </paper-material>  
    </div>
  </template>

  <script>
    (function() {
        'use strict';
        var app;
        var onDeviceReady = function() {
          if(localStorage != undefined){
            console.log("Local Storage is supported");
            //add
            localStorage.setItem("Website", "SitePoint");
            //update or overwrite
            localStorage.setItem("Website", "SitePoint.com");
            //remove
            localStorage.removeItem("Website");
            //remove all
            localStorage.clear();
          }
          else{
            console.log("No support");
          }
          cordova.plugins.BluetoothStatus.initPlugin();   
          cordova.plugins.BluetoothStatus.enableBT();
          window.addEventListener('BluetoothStatus.enabled', function() {
              console.log('Bluetooth has been enabled');
              connect();
          });        
        };
        var connect = function(e) {
          console.log("connecting ...");
            var onConnect = function() {
                    // subscribe for incoming data
                    bluetoothSerial.subscribe('\n', onData, onError);
                    //app.setStatus("Connected");
                };
            bluetoothSerial.connect("20:15:10:26:46:49", onConnect, onError);
        },
        onData = function(data) { // data received from Arduino
            console.log("received : " + data);
            console.log(app.message);
            app.message += "Received: " + data;
            //resultDiv.scrollTop = resultDiv.scrollHeight;
        },
        onError = function(reason) {
            alert("ERROR: " + reason); // real apps should use notification.alert
        };
        onDeviceReady();
      Polymer({
        is: 'my-farm',
        properties: {
        },
        ready: function () {
          app = this;
          console.log("my-farm has been loaded");
          app.list();   
          this.$.interrupt.addEventListener('change', function () {
            app.send("" + (this.checked ? "1" : "0"));
          });
          app.message = "Start : ";
        },
        
        refreshDeviceList: function() {
            //setTimeout(function(){ bluetoothSerial.discoverUnpaired(this.onDeviceList, this.onError); },5000);
            //bluetoothSerial.discoverUnpaired(app.onDeviceList, app.onError);   
            bluetoothSerial.list(app.onDeviceList, app.onError);        
            console.log("refreshDeviceList");
            //bluetoothSerial.setDeviceDiscoveredListener(app.onDeviceList);
        },
        list : function(){
            var failure = function(message) {
                console.log(message);
            };
            bluetoothSerial.list(function(devices) {
                devices.forEach(function(device) {
                    add(device.id);
                })
            }, failure);
        },

        send: function(data) {
          console.log("sending : " + data);
            var success = function() {
                console.log("success: " + data);
                app.message+= "Sent: " + data + "<br/>";
                //resultDiv.scrollTop = resultDiv.scrollHeight;
            };

            var failure = function() {
                alert("Failed writing data to Bluetooth peripheral");
            };
            bluetoothSerial.write(data, success, failure);
        },
        disconnect: function(event) {
            bluetoothSerial.disconnect(app.showMainPage, app.onError);
        }
      });
    var add = function(name) {
              //Create an input type dynamically.   
              var element = document.createElement("input");
              //Assign different attributes to the element. 
              element.type = "button";
              element.value = name; // Really? You want the default value to be the type string?
              element.name = name;  // And the name too?
              element.onclick = function() { // Note app is a function
                  alert("blabla");
              };

              var foo = document.getElementById("fooBar");
              //Append the element in page (in span).  
              foo.appendChild(element);
    }

    })();
    

  </script>
</dom-module>
